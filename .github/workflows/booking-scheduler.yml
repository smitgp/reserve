name: Library Booking Scheduler

on:
  schedule:
    # Start early to account for GitHub Actions delay (slots open at 19:00 Netherlands time)
    # Scheduled at 18:55 to account for ~3-5 minute delay, should hit around 19:00
    - cron: '55 16 * * *'  # 18:55 CEST (summer: UTC+2) - will retry every 10s for 3 minutes
    - cron: '55 17 * * *'  # 18:55 CET (winter: UTC+1) - will retry every 10s for 3 minutes
    # Backup schedules every minute during critical window
    - cron: '0 17 * * *'  # 19:00 CEST (summer)
    - cron: '0 18 * * *'  # 19:00 CET (winter)
    - cron: '1 17 * * *'  # 19:01 CEST (summer)
    - cron: '1 18 * * *'  # 19:01 CET (winter)
    - cron: '2 17 * * *'  # 19:02 CEST (summer)
    - cron: '2 18 * * *'  # 19:02 CET (winter)
  
  # Trigger immediate booking attempt when changes are pushed
  push:
    branches: [ main ]
    paths:
      - 'bookings.yml'
      - 'booking-scheduler.mjs'
      - '.github/workflows/booking-scheduler.yml'
  
  workflow_dispatch:
    inputs:
      force_date:
        description: 'Force booking for specific date (YYYY-MM-DD)'
        required: false
        type: string
      dry_run:
        description: 'Dry run - check what would be booked'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  check-and-book:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Create .env file
      env:
        EMAIL: ${{ secrets.EMAIL }}
        LOCATION: ${{ secrets.LOCATION }}
        TYPE: ${{ secrets.TYPE }}
        BASE_EMAIL: ${{ secrets.BASE_EMAIL }}
        ENGINE_BODY: ${{ secrets.ENGINE_BODY }}
      run: |
        cat > .env << EOF
        EMAIL=${{ secrets.EMAIL }}
        LOCATION=${{ secrets.LOCATION }}
        TYPE=${{ secrets.TYPE }}
        BASE_EMAIL=${{ secrets.BASE_EMAIL }}
        ENGINE_BODY=${{ secrets.ENGINE_BODY }}
        EOF
        
    - name: Check and book scheduled reservations
      env:
        FORCE_DATE: ${{ github.event.inputs.force_date }}
        DRY_RUN: ${{ github.event.inputs.dry_run }}
      run: |
        echo "ðŸ” Checking for bookings scheduled for today..."
        node booking-scheduler.mjs
        
    - name: Commit booking status updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action - Scheduler"
        git add bookings.yml
        
        if git diff --staged --quiet; then
          echo "ðŸ“­ No booking status changes to commit"
        else
          git commit -m "ðŸ¤– Update booking status after scheduler run

          ðŸ• Executed: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          ðŸ“… For date: ${FORCE_DATE:-$(date -u '+%Y-%m-%d')}
          ðŸ”§ Mode: ${DRY_RUN:-live}"
          
          git push
          echo "âœ… Booking status updates committed to repository"
        fi